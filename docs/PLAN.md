# PLAN.md — Пошаговый план реализации FORMA

> Версия: v0.1 | Дата: 2026-02-14

## Этапы

| Этап | Описание | Приоритет |
|------|----------|-----------|
| 0 | Инфраструктура и каркас | Блокирующий |
| 1 | Ядро: теги, стили, каталог | MVP |
| 2 | Генерация + мутации | MVP |
| 3 | Пользовательская часть (UI) | MVP |
| 4 | Заказы, оплата, штрихкоды | MVP |
| 5 | Админка | MVP |
| 6 | Лимиты и монетизация генераций | MVP |
| 7 | Шаринг и социальность | MVP |
| 8 | Полировка, тесты, деплой | MVP |
| 9 | Пост-MVP: дропы, семантический поиск, создатели | Фаза 2 |

---

## Этап 0. Инфраструктура и каркас

- [x] Создать Rails-проект (Ruby on Rails 7+)
- [x] Настроить PostgreSQL (extensions: citext, pg_trgm, unaccent)
- [x] Настроить Redis + Sidekiq
- [x] Настроить ActiveStorage + S3-compatible (Yandex Object Storage / MinIO)
- [ ] Настроить CI/CD (опционально, но рекомендуется)
- [ ] Настроить линтеры (RuboCop, etc.)
- [x] Создать базовые миграции: users, oauth_identities, anonymous_identities
- [x] Настроить OmniAuth (VK, Яндекс, T-Bank, Альфа, Gmail)
- [x] Базовая аутентификация (сессии/токены)
- [x] Конвенция enum: только строчные (string), не integer
- [x] Конвенция деньги: integer _cents
- [x] Настроить hashid-rails (gem `hashid-rails`, 6 символов, публичные ID)
- [x] Seed-данные: admin user, базовые app_settings

**Результат:** Rails-приложение запускается, авторизация работает, S3 подключен.

---

## Этап 1. Ядро: теги, стили, каталог

### 1.1. Теги
- [x] Миграция: tag_categories
- [x] Миграция: tags (visibility: string, kind: string, weight, is_banned)
- [x] Миграция: tag_synonyms
- [x] Миграция: tag_relations
- [x] Модель Tag + валидации
- [x] Модель TagCategory + валидации
- [x] Модель TagSynonym
- [x] Модель TagRelation
- [x] Сервис: CSV-импорт тегов
- [x] Seed-данные: базовый набор тегов по категориям (страны, сезоны, стихии, материалы, настроения)
- [x] Trigram-индекс на tags.name для автодополнения

### 1.2. Стили
- [x] Миграция: styles (status: string, generation_preset: jsonb)
- [x] Миграция: style_tags (M2M)
- [x] Модель Style + ActiveStorage (cover_image, gallery_images)
- [x] Модель StyleTag
- [ ] Seed-данные: 10-30 стилей с тегами и изображениями

### 1.3. Каталог
- [x] Миграция: catalog_sections, catalog_items
- [x] Модели CatalogSection, CatalogItem
- [x] Эндпойнт: GET /catalog/styles (список стилей)
- [x] Логика "Редакция FORMA" (стили с rating >= 4)

**Результат:** Есть теги, стили, каталог. Можно наполнять через seed/консоль.

---

## Этап 2. Генерация + мутации

### 2.1. Дизайны
- [x] Миграция: designs (visibility: string, moderation_status: string, search_vector: tsvector)
- [x] Миграция: design_tags (M2M)
- [x] Модель Design + ActiveStorage (hero_image, share_image)
- [x] Модель DesignTag

### 2.2. Генерации
- [x] Миграция: generations (source: string, status: string)
- [x] Миграция: generation_variants (kind: string, status: string)
- [x] Модель Generation + state machine
- [x] Модель GenerationVariant + state machine + ActiveStorage (preview_image, mockup_image, hires_image)

### 2.3. Провайдер генерации
- [x] Абстракция GenerationProvider (interface)
- [x] Реализация первого провайдера (Stable Diffusion / DALL-E / Midjourney API / etc.)
- [x] Конфигурация провайдера через app_settings

### 2.4. Prompt Composer
- [x] Сервис PromptComposer: сборка финального промпта
- [x] Учет стиля, тегов, скрытых тегов
- [x] Системные ограничения (no logos, brand mood only)

### 2.5. Tag Mutation Engine
- [x] Сервис TagMutationEngine: выбор 1-2 тегов для мутаций
- [x] Учет предпочтений, совместимости, запретов
- [x] Генерация mutation_summary ("заменили X на Y")

### 2.6. Пайплайн
- [x] Sidekiq Job: GenerationJob
- [x] Создание 3 вариантов (main + mutation_a + mutation_b)
- [x] Параллельная отправка провайдеру
- [x] Сохранение результатов в ActiveStorage
- [x] Обновление статусов (created -> queued -> running -> succeeded/failed)

### 2.7. Мокапы
- [ ] Пост-обработка: наложение превью на шаблон блокнота
- [ ] Генерация thumbnail

**Результат:** Можно запустить генерацию, получить 3 превью с мутациями.

---

## Этап 3. Пользовательская часть (UI)

### 3.1. Layout и навигация
- [x] Mobile-first layout (Hotwire/Turbo или API + фронт)
- [x] Нижний tab bar: Каталог, Создать, Поиск, Избранное, Профиль
- [x] Общие компоненты: карточки, чипсы, кнопки, скелетоны
- [x] Toast/снэкбар

### 3.2. Онбординг вкуса (S2)
- [ ] Экран "Выбери, что нравится"
- [ ] Свайп-карточки или сетка
- [ ] Миграция: style_votes
- [ ] Модель StyleVote
- [ ] Логика: профиль предпочтений (веса тегов)
- [ ] Прогресс "Выбрано: X/5"
- [ ] Переход в "Создать" с пресетом

### 3.3. Каталог (S1)
- [x] Главная витрина: секции
- [x] Карточки дизайнов/стилей
- [x] Горизонтальный скролл "Редакция FORMA"
- [x] "Популярное сегодня"

### 3.4. Создание (S3)
- [x] Поле промпта
- [x] Чипсы тегов по категориям
- [ ] Быстрые пресеты
- [x] CTA "Сгенерировать (Pro)"

### 3.5. Генерация/прогресс (S4)
- [x] Экран прогресса с шагами
- [ ] "Пока ждешь — посмотри популярное"
- [x] Обработка таймаута и ошибок

### 3.6. Результат (S5) — ключевой экран
- [x] Горизонтальная лента 3 карточек
- [x] Мокап + плашка мутации
- [x] Кнопки: Выбрать, Докрутить
- [x] Панель: Сохранить, Поделиться, Ремикс
- [x] Обработка partial/failed

### 3.7. Докрутка (S6b)
- [ ] Быстрые замены (чипсы)
- [ ] Теги по вкладкам
- [ ] Поле "Скажи словами"
- [ ] CTA "Обновить (3 превью)"

### 3.8. Страница дизайна (S7)
- [x] Публичная страница по slug или hashid
- [x] OG/meta-теги для шаринга
- [x] Кнопки: Ремикснуть, Заказать
- [x] Блоки: ремиксы, похожие

### 3.9. Поиск (S13)
- [ ] Full-text поиск по designs (tsvector)
- [ ] Фильтры по тегам
- [ ] Автодополнение (trigram)
- [ ] Сортировка: популярное/новое

### 3.10. Профиль (S15, S16, S17)
- [ ] Профиль (гость/авторизован)
- [ ] Мои дизайны (S16)
- [ ] Мои заказы (S17)
- [x] Избранное (S14)

**Результат:** Полный пользовательский флоу от каталога до результата генерации.

---

## Этап 4. Заказы, оплата, штрихкоды

### 4.1. Наполнения
- [x] Миграция: fillings
- [x] Модель Filling + ActiveStorage (preview_spread_image)
- [x] Seed-данные: клетка, линейка, точки, пустые
- [x] Экран выбора наполнения (S8)

### 4.2. SKU
- [x] Миграция: notebook_skus
- [x] Seed-данные: Base (259900), Pro (319900), Elite (899900)
- [x] Экран выбора комплектации (S9)

### 4.3. Заказы
- [x] Миграция: orders, order_items
- [x] Модель Order + state machine
- [x] Модель OrderItem
- [x] Генерация order_number (FORMA-YYYY-NNNNNN)
- [x] Генерация barcode (Code128)
- [x] Экран оформления (S10)

### 4.4. ЮKassa
- [x] Миграция: payments
- [x] Модель Payment
- [x] Интеграция: создание платежа (YooKassa API)
- [x] Webhook endpoint: POST /payments/yookassa/webhook
- [x] Идемпотентность обработки
- [x] Redirect flow (S11)
- [x] Экран "Заказ принят" (S12)

### 4.5. Файлы производства
- [x] Миграция: order_files
- [x] Модель OrderFile + ActiveStorage
- [x] Job: генерация cover_print_pdf (заглушка)
- [x] Job: генерация inner_print_pdf (заглушка)
- [x] Job: генерация dna_card_pdf (заглушка)

**Результат:** Можно оформить заказ, оплатить, получить штрихкод и файлы для печати.

---

## Этап 5. Админка

### 5.1. Базовая админка
- [x] Admin layout (отдельный namespace /admin)
- [x] Авторизация (проверка role == "admin")
- [x] Миграция: audit_logs
- [x] Модель AuditLog (AppSetting уже из Этапа 0)

### 5.2. Управление тегами
- [x] CRUD тегов (список, создание, редактирование, удаление)
- [x] Фильтры: категория, visibility, is_banned, поиск
- [x] CSV-импорт
- [x] Управление синонимами
- [ ] Управление совместимостью (tag_relations) — UI
- [x] Мердж дублей

### 5.3. Управление стилями
- [x] CRUD стилей
- [x] Загрузка изображений
- [x] Привязка тегов
- [x] Управление пресетом генерации
- [x] Публикация / скрытие

### 5.4. Режим "Куратор"
- [ ] Экран batch-генерации
- [ ] Просмотр результатов
- [ ] Оценка 1-5 (design_ratings, source: "admin")
- [ ] "Добавить в каталог"
- [ ] "Создать стиль из результата"

### 5.5. Управление заказами
- [x] Список заказов с фильтрами
- [x] Карточка заказа (все блоки)
- [x] Смена статуса (кнопки)
- [x] Просмотр файлов производства
- [x] Экспорт CSV
- [ ] Экспорт PDF (лист комплектации, наклейки штрихкодов)

### 5.6. Настройки
- [x] UI для app_settings (лимиты, цены, параметры безлимита)
- [x] Аудит-лог (просмотр с фильтрами)

**Результат:** Админ может управлять всем контентом, заказами, настройками.

---

## Этап 6. Лимиты и монетизация генераций

- [x] Миграция: generation_passes, usage_counters
- [x] Модели GenerationPass, UsageCounter
- [x] Сервис: проверка лимита перед генерацией
- [x] Инкремент счетчика при каждой генерации
- [x] Экран "Лимит исчерпан" (L1)
- [x] Покупка безлимита: оплата через ЮKassa (payable_type: "GenerationPass")
- [x] Rate limiting (Redis)
- [x] Антиабуз: IP + fingerprint для гостей

**Результат:** Работают лимиты, можно купить безлимит за 100 ₽.

---

## Этап 7. Шаринг и социальность

### 7.1. Ремиксы
- [x] Логика fork (designs.source_design_id)
- [x] UI: кнопка "Ремикснуть" -> S6b
- [x] Блок "Ремиксы" на странице дизайна

### 7.2. Шаринг
- [x] Генерация share-картинки (превью + лого FORMA)
- [x] Кнопка "Поделиться" (системный share)
- [x] OG/meta-теги на S7
- [x] Watermark (минимальный)

### 7.3. Избранное
- [x] Миграция: favorites
- [x] Модель Favorite
- [x] UI: кнопка "Сохранить", экран избранного (S14)

### 7.4. Популярное
- [x] Sidekiq Job: пересчет popularity_score
- [x] Витрина "Популярное сегодня" на S1
- [x] Миграция: design_ratings (пользовательские оценки)

**Результат:** Работают ремиксы, шаринг, избранное, популярное.

---

## Этап 8. Полировка, тесты, деплой

- [x] Unit-тесты моделей
- [x] Integration-тесты ключевых флоу (генерация, заказ, оплата)
- [x] Тесты webhook-ов ЮKassa
- [x] Mobile UX полировка
- [x] Прогрессивная загрузка изображений (thumb -> medium)
- [x] Обработка всех ошибочных состояний (S4, S5, S11)
- [x] Мониторинг и логирование (генерации, оплаты)
- [ ] Деплой на staging
- [ ] Наполнение контентом (30-50 стилей, 200-500 дизайнов через куратор)
- [ ] Smoke-тестирование на реальных устройствах
- [ ] Деплой на production

**Результат:** MVP готов к запуску.

---

## Этап 9. Пост-MVP (Фаза 2)

- [ ] Дропы / Edition numbering (drops, drop_items, edition_assignments)
- [ ] Роль "Создатель" + публикация промптов/стилей
- [ ] Семантический поиск (векторный)
- [ ] Расширенные наполнения (датированный планер)
- [ ] Персонализация ленты "Популярное для вас"
- [ ] A/B тесты входного каталога
- [ ] Расширение тарифов (реальные различия Base/Pro/Elite в производстве)
- [ ] PWA: "установить на экран"
- [ ] Улучшенная модерация и антиабуз
- [ ] Промокоды

---

## Зависимости между этапами

```
Этап 0 (инфраструктура)
  |
  v
Этап 1 (теги, стили, каталог) ----> Этап 5 (админка)
  |
  v
Этап 2 (генерация + мутации)
  |
  v
Этап 3 (UI) -----> Этап 7 (шаринг, социальность)
  |
  v
Этап 4 (заказы, оплата) -----> Этап 6 (лимиты)
  |
  v
Этап 8 (полировка, деплой)
  |
  v
Этап 9 (пост-MVP)
```

**Примечание:** Этап 5 (админка) можно начинать параллельно с Этапом 2, как только готов Этап 1.
