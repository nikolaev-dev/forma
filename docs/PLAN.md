# PLAN.md — Пошаговый план реализации FORMA

> Версия: v0.2 | Дата: 2026-02-15

## Фазы

| Фаза | Этапы | Описание | Статус |
|------|-------|----------|--------|
| Фаза 1 (v0.1) | 0-8 | MVP: инфраструктура, ядро, генерация, UI, заказы, админка, лимиты, шаринг, полировка | В основном завершена |
| Фаза 2 (v0.2) | 9-15 | Tier System, Brand Identity, Коллекции, Training Pipeline, UX-дыры, деплой | Планируется |
| Фаза 3 (v0.3) | 16+ | Создатели, семантический поиск, персонализация, промокоды | Будущее |

---

## Фаза 1 (v0.1): MVP

### Этап 0. Инфраструктура и каркас

- [x] Создать Rails-проект (Ruby on Rails 7+)
- [x] Настроить PostgreSQL (extensions: citext, pg_trgm, unaccent)
- [x] Настроить Redis + Sidekiq
- [x] Настроить ActiveStorage + S3-compatible (Yandex Object Storage / MinIO)
- [x] Настроить CI/CD (GitHub Actions: lint, test, security scan, dependabot)
- [x] Настроить линтеры (RuboCop rails-omakase, 0 offenses)
- [x] Создать базовые миграции: users, oauth_identities, anonymous_identities
- [x] Настроить OmniAuth (VK, Яндекс, T-Bank, Альфа, Gmail)
- [x] Базовая аутентификация (сессии/токены)
- [x] Конвенция enum: только строчные (string), не integer
- [x] Конвенция деньги: integer _cents
- [x] Настроить hashid-rails (gem `hashid-rails`, 6 символов, публичные ID)
- [x] Seed-данные: admin user, базовые app_settings

**Результат:** Rails-приложение запускается, авторизация работает, S3 подключен.

---

### Этап 1. Ядро: теги, стили, каталог

#### 1.1. Теги
- [x] Миграция: tag_categories
- [x] Миграция: tags (visibility: string, kind: string, weight, is_banned)
- [x] Миграция: tag_synonyms
- [x] Миграция: tag_relations
- [x] Модель Tag + валидации
- [x] Модель TagCategory + валидации
- [x] Модель TagSynonym
- [x] Модель TagRelation
- [x] Сервис: CSV-импорт тегов
- [x] Seed-данные: базовый набор тегов по категориям (страны, сезоны, стихии, материалы, настроения)
- [x] Trigram-индекс на tags.name для автодополнения

#### 1.2. Стили
- [x] Миграция: styles (status: string, generation_preset: jsonb)
- [x] Миграция: style_tags (M2M)
- [x] Модель Style + ActiveStorage (cover_image, gallery_images)
- [x] Модель StyleTag
- [ ] Seed-данные: 10-30 стилей с тегами и изображениями

#### 1.3. Каталог
- [x] Миграция: catalog_sections, catalog_items
- [x] Модели CatalogSection, CatalogItem
- [x] Эндпойнт: GET /catalog/styles (список стилей)
- [x] Логика "Редакция FORMA" (стили с rating >= 4)

**Результат:** Есть теги, стили, каталог. Можно наполнять через seed/консоль.

---

### Этап 2. Генерация + мутации

#### 2.1. Дизайны
- [x] Миграция: designs (visibility: string, moderation_status: string, search_vector: tsvector)
- [x] Миграция: design_tags (M2M)
- [x] Модель Design + ActiveStorage (hero_image, share_image)
- [x] Модель DesignTag

#### 2.2. Генерации
- [x] Миграция: generations (source: string, status: string)
- [x] Миграция: generation_variants (kind: string, status: string)
- [x] Модель Generation + state machine
- [x] Модель GenerationVariant + state machine + ActiveStorage (preview_image, mockup_image, hires_image)

#### 2.3. Провайдер генерации
- [x] Абстракция GenerationProvider (interface)
- [x] Реализация первого провайдера (Stable Diffusion / DALL-E / Midjourney API / etc.)
- [x] Конфигурация провайдера через app_settings

#### 2.4. Prompt Composer
- [x] Сервис PromptComposer: сборка финального промпта
- [x] Учет стиля, тегов, скрытых тегов
- [x] Системные ограничения (no logos, brand mood only)

#### 2.5. Tag Mutation Engine
- [x] Сервис TagMutationEngine: выбор 1-2 тегов для мутаций
- [x] Учет предпочтений, совместимости, запретов
- [x] Генерация mutation_summary ("заменили X на Y")

#### 2.6. Пайплайн
- [x] Sidekiq Job: GenerationJob
- [x] Создание 3 вариантов (main + mutation_a + mutation_b)
- [x] Параллельная отправка провайдеру
- [x] Сохранение результатов в ActiveStorage
- [x] Обновление статусов (created -> queued -> running -> succeeded/failed)

#### 2.7. Мокапы
- [ ] Пост-обработка: наложение превью на шаблон блокнота
- [ ] Генерация thumbnail

**Результат:** Можно запустить генерацию, получить 3 превью с мутациями.

---

### Этап 3. Пользовательская часть (UI)

#### 3.1. Layout и навигация
- [x] Mobile-first layout (Hotwire/Turbo)
- [x] Нижний tab bar: Каталог, Создать, Поиск, Избранное, Профиль
- [x] Общие компоненты: карточки, чипсы, кнопки, скелетоны
- [x] Toast/снэкбар

#### 3.2. Онбординг вкуса (S2)
- [ ] Экран "Выбери, что нравится"
- [ ] Свайп-карточки или сетка
- [ ] Миграция: style_votes
- [ ] Модель StyleVote
- [ ] Логика: профиль предпочтений (веса тегов)
- [ ] Прогресс "Выбрано: X/5"
- [ ] Переход в "Создать" с пресетом

#### 3.3. Каталог (S1)
- [x] Главная витрина: секции
- [x] Карточки дизайнов/стилей
- [x] Горизонтальный скролл "Редакция FORMA"
- [x] "Популярное сегодня"

#### 3.4. Создание (S3)
- [x] Поле промпта
- [x] Чипсы тегов по категориям
- [ ] Быстрые пресеты
- [x] CTA "Сгенерировать (Pro)"

#### 3.5. Генерация/прогресс (S4)
- [x] Экран прогресса с шагами
- [ ] "Пока ждешь — посмотри популярное"
- [x] Обработка таймаута и ошибок

#### 3.6. Результат (S5) — ключевой экран
- [x] Горизонтальная лента 3 карточек
- [x] Мокап + плашка мутации
- [x] Кнопки: Выбрать, Докрутить
- [x] Панель: Сохранить, Поделиться, Ремикс
- [x] Обработка partial/failed

#### 3.7. Докрутка (S6b)
- [ ] Быстрые замены (чипсы)
- [ ] Теги по вкладкам
- [ ] Поле "Скажи словами"
- [ ] CTA "Обновить (3 превью)"

#### 3.8. Страница дизайна (S7)
- [x] Публичная страница по slug или hashid
- [x] OG/meta-теги для шаринга
- [x] Кнопки: Ремикснуть, Заказать
- [x] Блоки: ремиксы, похожие

#### 3.9. Поиск (S13)
- [ ] Full-text поиск по designs (tsvector)
- [ ] Фильтры по тегам
- [ ] Автодополнение (trigram)
- [ ] Сортировка: популярное/новое

#### 3.10. Профиль (S15, S16, S17)
- [ ] Профиль (гость/авторизован)
- [ ] Мои дизайны (S16)
- [ ] Мои заказы (S17)
- [x] Избранное (S14)

**Результат:** Полный пользовательский флоу от каталога до результата генерации.

---

### Этап 4. Заказы, оплата, штрихкоды

#### 4.1. Наполнения
- [x] Миграция: fillings
- [x] Модель Filling + ActiveStorage (preview_spread_image)
- [x] Seed-данные: клетка, линейка, точки, пустые
- [x] Экран выбора наполнения (S8)

#### 4.2. SKU
- [x] Миграция: notebook_skus
- [x] Seed-данные: Base (259900), Pro (319900), Elite (899900)
- [x] Экран выбора комплектации (S9)

#### 4.3. Заказы
- [x] Миграция: orders, order_items
- [x] Модель Order + state machine
- [x] Модель OrderItem
- [x] Генерация order_number (FORMA-YYYY-NNNNNN)
- [x] Генерация barcode (Code128)
- [x] Экран оформления (S10)

#### 4.4. ЮKassa
- [x] Миграция: payments
- [x] Модель Payment
- [x] Интеграция: создание платежа (YooKassa API)
- [x] Webhook endpoint: POST /payments/yookassa/webhook
- [x] Идемпотентность обработки
- [x] Redirect flow (S11)
- [x] Экран "Заказ принят" (S12)

#### 4.5. Файлы производства
- [x] Миграция: order_files
- [x] Модель OrderFile + ActiveStorage
- [x] Job: генерация cover_print_pdf (заглушка)
- [x] Job: генерация inner_print_pdf (заглушка)
- [x] Job: генерация dna_card_pdf (заглушка)

**Результат:** Можно оформить заказ, оплатить, получить штрихкод и файлы для печати.

---

### Этап 5. Админка

#### 5.1. Базовая админка
- [x] Admin layout (отдельный namespace /admin)
- [x] Авторизация (проверка role == "admin")
- [x] Миграция: audit_logs
- [x] Модель AuditLog

#### 5.2. Управление тегами
- [x] CRUD тегов (список, создание, редактирование, удаление)
- [x] Фильтры: категория, visibility, is_banned, поиск
- [x] CSV-импорт
- [x] Управление синонимами
- [ ] Управление совместимостью (tag_relations) — UI
- [x] Мердж дублей

#### 5.3. Управление стилями
- [x] CRUD стилей
- [x] Загрузка изображений
- [x] Привязка тегов
- [x] Управление пресетом генерации
- [x] Публикация / скрытие

#### 5.4. Режим "Куратор"
- [ ] Экран batch-генерации
- [ ] Просмотр результатов
- [ ] Оценка 1-5 (design_ratings, source: "admin")
- [ ] "Добавить в каталог"
- [ ] "Создать стиль из результата"

#### 5.5. Управление заказами
- [x] Список заказов с фильтрами
- [x] Карточка заказа (все блоки)
- [x] Смена статуса (кнопки)
- [x] Просмотр файлов производства
- [x] Экспорт CSV
- [ ] Экспорт PDF (лист комплектации, наклейки штрихкодов)

#### 5.6. Настройки
- [x] UI для app_settings (лимиты, цены, параметры безлимита)
- [x] Аудит-лог (просмотр с фильтрами)

**Результат:** Админ может управлять всем контентом, заказами, настройками.

---

### Этап 6. Лимиты и монетизация генераций

- [x] Миграция: generation_passes, usage_counters
- [x] Модели GenerationPass, UsageCounter
- [x] Сервис: проверка лимита перед генерацией
- [x] Инкремент счетчика при каждой генерации
- [x] Экран "Лимит исчерпан" (L1)
- [x] Покупка безлимита: оплата через ЮKassa (payable_type: "GenerationPass")
- [x] Rate limiting (Redis)
- [x] Антиабуз: IP + fingerprint для гостей

**Результат:** Работают лимиты, можно купить безлимит за 100 руб.

---

### Этап 7. Шаринг и социальность

#### 7.1. Ремиксы
- [x] Логика fork (designs.source_design_id)
- [x] UI: кнопка "Ремикснуть" -> S6b
- [x] Блок "Ремиксы" на странице дизайна

#### 7.2. Шаринг
- [x] Генерация share-картинки (превью + лого FORMA)
- [x] Кнопка "Поделиться" (системный share)
- [x] OG/meta-теги на S7
- [x] Watermark (минимальный)

#### 7.3. Избранное
- [x] Миграция: favorites
- [x] Модель Favorite
- [x] UI: кнопка "Сохранить", экран избранного (S14)

#### 7.4. Популярное
- [x] Sidekiq Job: пересчет popularity_score
- [x] Витрина "Популярное сегодня" на S1
- [x] Миграция: design_ratings (пользовательские оценки)

**Результат:** Работают ремиксы, шаринг, избранное, популярное.

---

### Этап 8. Полировка, тесты, деплой

- [x] Unit-тесты моделей
- [x] Integration-тесты ключевых флоу (генерация, заказ, оплата)
- [x] Тесты webhook-ов ЮKassa
- [x] Mobile UX полировка
- [x] Прогрессивная загрузка изображений (thumb -> medium)
- [x] Обработка всех ошибочных состояний (S4, S5, S11)
- [x] Мониторинг и логирование (генерации, оплаты)
- [ ] Деплой на staging
- [ ] Наполнение контентом (30-50 стилей, 200-500 дизайнов через куратор)
- [ ] Smoke-тестирование на реальных устройствах
- [ ] Деплой на production

**Результат:** MVP готов к запуску.

---

## Фаза 2 (v0.2): Tier System + Training Pipeline + Коллекции

> Ключевые изменения: 3-уровневая продуктовая линейка (Core / Signature / Lux),
> физическая brand identity, training pipeline для обработки референсов,
> коллекции + дропы.

---

### Этап 9. Tier System (Core / Signature / Lux)

> Переход от абстрактных Base/Pro/Elite к продуктам с реальной разницей в производственных технологиях.

#### 9.1. Переименование SKU
- [x] Миграция: обновить notebook_skus (base→core, pro→signature, elite→lux)
- [ ] Обновить цены (TBD — определяются позже)
- [ ] Обновить specs (jsonb): производственные параметры каждого уровня
- [ ] Обновить brand_elements (jsonb): что входит в каждый уровень
- [x] Seed-данные: обновленные SKU

#### 9.2. Tier-ось в генерации
- [x] Миграция: GenerationVariant + tier (string: core/signature/lux, nullable)
- [x] Миграция: tier_modifiers (tier, prompt_modifier, identity_elements, negative_prompt, settings)
- [x] Модель TierModifier
- [x] Seed-данные: tier_modifiers для core/signature/lux (из brainstorm)

#### 9.3. Обновление PromptComposer
- [x] Расширить PromptComposer: принимает tier как параметр (TierPromptComposer — отдельный сервис)
- [x] Шаблон промпта: `{scene} + {design_prompt} + {tier_modifier} + {identity} + {negative}`
- [ ] Предпросмотр финального промпта для каждого уровня

#### 9.4. Tier в заказах
- [x] Миграция: order_items + tier (string)
- [x] Обновить OrderItem: сохранять tier при оформлении
- [ ] Обновить экран S9: визуальный выбор уровня с 3 разными превью

**Результат:** 3 уровня продукта с производственной разницей, tier-специфичные промпты.

---

### Этап 10. Brand Identity (FORMA DNA)

> 4 обязательных элемента бренда в каждом блокноте. Волна — опциональный стилевой элемент.

#### 10.1. Обязательные элементы identity
- [ ] Шестигранный шильд (hex badge): Core=принт, Signature=слепое тиснение, Lux=полированный металл
- [ ] Две закладки: Core/Signature=тканевые, Lux=с hex-наконечниками
- [ ] Срезанный угол 45° (верхний правый): все уровни одинаково
- [ ] Карточка/паспорт FORMA DNA: Core=простая, Signature=персонализированная, Lux=номерной паспорт

#### 10.2. Волна (опциональный элемент)
- [ ] S-curve волна — рекомендуемый стилевой элемент, не обязательный
- [ ] Если используется: Core=плоский принт, Signature=spot UV лак, Lux=embossing + doming-линза

#### 10.3. Identity в промптах
- [ ] Добавить identity_elements в tier_modifiers
- [ ] Обновить промпт-систему для включения identity при генерации

#### 10.4. Обновление DNA Card
- [ ] Tier-специфичный дизайн карточки
- [ ] Для лимиток: номер экземпляра + паспорт коллекционера

**Результат:** Каждый блокнот FORMA узнаваем по 4 физическим элементам бренда.

---

### Этап 11. Коллекции

> Коллекция — группировка дизайнов по теме/настроению. Regular (без лимита) или Limited (тираж N шт).

- [x] Миграция: collections (name, slug, description, collection_type: regular/limited, edition_size, stock_remaining, is_active, position)
- [x] Модель Collection + ActiveStorage (cover_image) + валидации
- [x] Миграция: designs + collection_id (FK, nullable)
- [ ] CRUD коллекций в админке
- [ ] Публичная страница коллекции: `/collections/:slug`
- [ ] Витрина коллекций на S1 (новая секция)
- [ ] Лимитированные коллекции: отображение "Осталось X/N"
- [x] Stock tracking: декремент при оформлении заказа
- [ ] Привязка дизайнов к коллекциям (админка + API)

**Результат:** Дизайны группируются в коллекции, лимитированные серии с учетом остатков.

---

### Этап 12. Дропы

> Дроп — лимитированный выпуск с нумерацией экземпляров. Связан с коллекцией (collection_type: limited).

- [ ] Миграция: drops (если не создана в v0.1), обновить
- [ ] Миграция: drop_items (привязка дизайнов)
- [ ] Миграция: edition_assignments (нумерация экземпляров)
- [ ] Модель Drop + state machine (draft/published/closed)
- [ ] Модель DropItem
- [ ] Модель EditionAssignment + присвоение номера при покупке
- [ ] Связь Drop ↔ Collection (drop belongs_to collection, optional)
- [ ] CRUD дропов в админке
- [ ] Публичная страница дропа: `/drops/:slug`
- [ ] Отображение нумерации "043/300" при заказе и на DNA Card

**Результат:** Лимитированные выпуски с нумерацией, привязанные к коллекциям.

---

### Этап 13. Training Pipeline

> Обработка референсных фото: AI-анализ, курирование, 3-tier генерация.

#### 13.1. Загрузка референсов
- [x] Миграция: training_batches (name, status, images_count, created_by_user_id)
- [x] Миграция: reference_images (training_batch_id, status, ai_analysis_claude, ai_analysis_openai, selected_provider, curated_prompt, collection_id, design_id, curator_notes)
- [x] Модель TrainingBatch + state machine (uploaded/processing/completed)
- [x] Модель ReferenceImage + state machine (uploaded/analyzing/analyzed/curated/generated/published/rejected) + ActiveStorage (original_image)
- [ ] Админка: загрузка референсов (drag-n-drop / ZIP)
- [ ] Группировка в батчи, превью-сетка с фильтрами по статусу

#### 13.2. AI-анализ изображений
- [x] Интеграция Claude Vision API
- [x] Интеграция GPT-4V API (A/B сравнение)
- [x] Sidekiq Job: ReferenceImageAnalysisJob (пакетный)
- [x] Извлечение: описание, базовый промпт, теги (матчинг с таксономией), mood, цвета, стиль, сложность
- [x] Хранение результатов в ai_analysis_claude / ai_analysis_openai (jsonb)
- [x] Идемпотентность: повторный анализ не затирает курированные данные

#### 13.3. Курирование
- [ ] Админ-карточка референса: оригинал + AI-предложения (side-by-side)
- [ ] Выбор провайдера (какой промпт лучше): selected_provider
- [ ] Inline-редактирование промпта
- [ ] Чипсы тегов с автодополнением
- [ ] Назначение коллекции (существующей или новой)
- [ ] Bulk-действия: "применить коллекцию ко всем выбранным"
- [x] Статус перехода: analyzed → curated

#### 13.4. 3-Tier генерация
- [x] Из curated промпта → 3 изображения (Core / Signature / Lux)
- [x] Каждый = GenerationVariant с tier-specific промптом
- [x] Адаптация Pipeline: generation.source = "training_pipeline"
- [ ] Курирование результатов: approve / reject / regenerate (по каждому уровню)
- [ ] A/B сравнение в курировании: оригинал слева, 3 tier справа

#### 13.5. Публикация
- [x] Одобренные → Design в каталоге (visibility: public)
- [x] Привязка к коллекции, стилю, тегам
- [x] 3 tier-варианта привязаны к Design
- [x] reference_image.design_id = created design
- [x] reference_image.status = published

**Результат:** 400+ референсов → AI-анализ → курирование → 3-tier дизайны в каталоге.

---

### Этап 14. Расширение админки (для v0.2)

- [ ] Управление tier_modifiers (CRUD + предпросмотр промптов для каждого уровня)
- [ ] Управление коллекциями (привязка дизайнов, обложки, типы regular/limited)
- [ ] Управление дропами (edition numbering, привязка к коллекциям)
- [ ] Расширенный режим "Куратор": batch-генерация с tier + коллекция
- [ ] Training pipeline dashboard: статистика батчей, прогресс обработки
- [ ] Batch-действия: "применить коллекцию", "сгенерировать 3 tier", "опубликовать все одобренные"

**Результат:** Админка поддерживает весь workflow v0.2.

---

### Этап 15. Оставшееся из MVP (UX-дыры)

> Задачи из Фазы 1, которые ещё не реализованы.

- [ ] Мокапы: пост-обработка (наложение превью на шаблон блокнота)
- [ ] Мокапы: генерация thumbnail
- [ ] Онбординг вкуса (S2): экран "Выбери, что нравится"
- [ ] Докрутка (S6b): быстрые замены, теги по вкладкам, "скажи словами"
- [ ] Поиск (S13): full-text + фильтры + автодополнение + сортировка
- [ ] Профиль (S15): гость / авторизован
- [ ] Мои дизайны (S16)
- [ ] Мои заказы (S17)
- [ ] Быстрые пресеты на S3
- [ ] "Пока ждешь" на S4
- [ ] Seed-данные: 10-30 стилей с тегами и изображениями
- [ ] Управление совместимостью тегов — UI в админке
- [ ] Экспорт PDF (лист комплектации, наклейки штрихкодов)

**Результат:** Все экраны и фичи MVP реализованы полностью.

---

### Этап 16. Деплой + наполнение

- [ ] Деплой на staging
- [ ] Наполнение через Training Pipeline: первые 50-100 референсов → AI → курирование → публикация
- [ ] Наполнение стилей: 30-50 стилей с тегами
- [ ] Создание 3-5 коллекций (включая 1 лимитированную)
- [ ] Smoke-тестирование на реальных устройствах
- [ ] Деплой на production

**Результат:** Продукт запущен с контентом.

---

## Фаза 3 (v0.3): Расширение

- [ ] Роль "Создатель" + публикация промптов/стилей
- [ ] Семантический поиск (векторный)
- [ ] Расширенные наполнения (датированный планер)
- [ ] Персонализация ленты "Популярное для вас"
- [ ] A/B тесты входного каталога
- [ ] PWA: "установить на экран"
- [ ] Улучшенная модерация и антиабуз
- [ ] Промокоды

---

## Зависимости между этапами

```
Фаза 1 (v0.1): Этапы 0-8 [в основном завершены]
  │
  ▼
Этап 9 (Tier System) ──────────────► Этап 10 (Brand Identity)
  │                                         │
  │                                         ▼
  ├───► Этап 11 (Коллекции) ──► Этап 12 (Дропы)
  │                     │
  │                     ▼
  │              Этап 13 (Training Pipeline)
  │                     │
  │                     ▼
  ├───► Этап 14 (Расширение админки) ◄── зависит от 9, 11, 12, 13
  │
  ├───► Этап 15 (UX-дыры) ◄── независим, можно параллельно
  │
  ▼
Этап 16 (Деплой) ◄── после 9-15
  │
  ▼
Фаза 3 (v0.3)
```

**Параллельность:**
- Этап 9 (Tier) и Этап 11 (Коллекции) — можно начинать параллельно
- Этап 15 (UX-дыры) — можно делать параллельно с любым этапом Фазы 2
- Этап 10 (Brand Identity) — после Этапа 9 (зависит от tier_modifiers)
- Этап 13 (Training Pipeline) — после Этапа 9 (tier-ось) и Этапа 11 (коллекции)
- Этап 12 (Дропы) — после Этапа 11 (коллекции)
