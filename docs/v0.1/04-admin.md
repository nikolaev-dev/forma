# 04. Админка — FORMA

> Версия: v0.1 | Дата: 2026-02-14

Админке уделяется столько же внимания, сколько пользовательской части — иначе нельзя "эволюционировать самому".

## 1. Разделы админки

| Раздел | Описание |
|--------|----------|
| Теги | CRUD, импорт, синонимы, совместимость |
| Стили | CRUD, привязка тегов, пресеты |
| Витрины / Подборки | Редакция, популярное, категории |
| Курация (Режим куратора) | Batch-генерации, оценки 1-5 |
| Заказы | Статусы, файлы, экспорт |
| Дропы / Edition | Лимитированные коллекции |
| Лимиты / Тарифы | Цены, лимиты, промокоды |
| Настройки | App settings, key-value |
| Аудит | Лог действий админов |

## 2. Управление тегами

### 2.1. CRUD тегов

| Поле | Тип | Описание |
|------|-----|----------|
| name | string | Название тега |
| slug | string | URL-slug (auto-generate) |
| tag_category_id | FK | Категория |
| visibility | string enum | `"public"` / `"hidden"` |
| kind | string enum | `"generic"` / `"brand_mood"` |
| weight | decimal | Вес для рекомендаций/мутаций |
| is_banned | boolean | Запрещен |
| banned_reason | string | Причина бана |

### 2.2. Массовый импорт CSV

- Формат: `name,category,visibility,kind`
- Валидация дублей
- Автогенерация slug
- Лог импорта (сколько создано, обновлено, ошибок)

### 2.3. Синонимы и транслитерации

- У каждого тега — список синонимов (tag_synonyms)
- Нормализованная форма для поиска
- Примеры: "кофе" = "coffee", "золото" = "gold"

### 2.4. Правила совместимости (tag_relations)

| Тип связи (string enum) | Описание |
|--------------------------|----------|
| `"parent_of"` | Иерархия |
| `"related"` | Связанные |
| `"conflicts_with"` | Нельзя вместе |
| `"discouraged_with"` | Нежелательно вместе |

### 2.5. Черный список

- Теги с `is_banned: true`
- Невидимы пользователю
- Блокируются при вводе промпта

### 2.6. Мердж дублей

- Выбор "основного" тега
- Перенос всех связей на основной
- Удаление дубля

## 3. Управление стилями

### 3.1. Карточка стиля

| Поле | Описание |
|------|----------|
| Название | Редакционное название |
| Описание | Короткое |
| 1-5 изображений | Примеры (ActiveStorage) |
| Набор тегов | Включая скрытые |
| Пресет генерации | JSON: параметры провайдера/модели/пост-обработки |
| Статус | `"draft"` / `"published"` / `"hidden"` |
| Позиция | Порядок в каталоге |
| Метрики | Просмотры / лайки / заказы (read-only) |

### 3.2. Статусы стиля (string enum)

```
"draft"      -> "published"  (публикация)
"published"  -> "hidden"     (скрытие)
"hidden"     -> "published"  (повторная публикация)
"draft"      -> (удаление)
```

## 4. Витрины / Подборки

### 4.1. Типы витрин (string enum)

| Тип | Описание |
|-----|----------|
| `"editorial"` | Редакция FORMA — ручной отбор |
| `"popular"` | Популярное — автоматически по метрикам |
| `"new"` | Новые — хронологически |
| `"drop"` | Дроп — привязка к Drop |
| `"custom"` | Произвольная подборка |

### 4.2. Функции

- Ручная фиксация карточек в топ (pinned)
- Расписание публикаций (опционально)
- Правила автонаполнения (JSON rules, например `rating>=4`)

## 5. Режим "Куратор"

### 5.1. Назначение

Интерфейс, где админ наполняет каталог качественными дизайнами.

### 5.2. Функции

| Действие | Описание |
|----------|----------|
| Batch-генерация | Запуск генерации пачками по стилю/набору тегов |
| Просмотр результатов | Лента сгенерированных вариантов |
| Оценка 1-5 | Быстрая оценка качества |
| "Доп. генерация" | Перегенерировать |
| "Добавь стиль" | Создать новый стиль из удачного результата |
| "Отправить в каталог" | Опубликовать дизайн |
| "Пометить теги" | Быстрый редактор тегов (включая скрытые) |

### 5.3. Поток работы

1. Админ выбирает стиль или набор тегов
2. Запускает batch (N генераций)
3. Просматривает результаты (лента карточек)
4. Ставит оценку 1-5
5. Лучшие (4-5) -> "Отправить в каталог"
6. Результат с оценкой >= 4 -> витрина "Редакция FORMA"

## 6. Управление заказами

### 6.1. Список заказов

**Фильтры:**
- Статус (draft, paid, in_production, shipped, delivered, canceled, refunded)
- Дата (от-до)
- Тариф (Base/Pro/Elite)
- Дроп / обычный
- Способ доставки
- Оплачен / не оплачен
- Поиск по номеру/почте/телефону

**Колонки таблицы:**
- Номер заказа
- Клиент
- Сумма
- Статус
- Дата
- Кнопка "Открыть"

### 6.2. Карточка заказа

| Блок | Содержимое |
|------|-----------|
| Клиент | Имя, телефон, email |
| Состав | Дизайн (ссылка), комплектация, наполнение, формат |
| Штрихкод | Визуально + значение (Code128) |
| Статусы | Timeline: paid -> in_production -> shipped -> delivered |
| Файлы производства | Обложка PDF, внутренний блок PDF, превью, DNA Card |
| Платежи | payment_id, статус, суммы, возвраты |

### 6.3. Смена статуса заказа

```
"draft" -> "awaiting_payment" -> "paid" -> "in_production" -> "shipped" -> "delivered"
"paid" -> "canceled"
"paid" -> "refunded"
```

Кнопки: "В производство", "Отправлен" (+ трек-номер), "Доставлен"

### 6.4. Экспорт

| Формат | Описание |
|--------|----------|
| CSV | Список заказов с фильтрами |
| PDF Лист комплектации | Для производства |
| PDF Наклейки штрихкодов | Пакетная печать |

### 6.5. Возвраты / Отмена

- Отмена до производства — автовозврат через YooKassa
- Отмена после — ручное решение
- Журнал действий (audit_logs)

## 7. Управление DNA Card и манифестом

| Настройка | Описание |
|-----------|----------|
| Шаблон манифеста | Текст по локалям |
| Формат DNA Card | Какие поля печатать, где QR, где ID |

## 8. Дропы (Drops) / Edition numbering

### 8.1. Создание дропа

| Поле | Описание |
|------|----------|
| Название | "Drop #1: Minimal Winter" |
| Slug | URL-идентификатор |
| Период | starts_at — ends_at |
| Лимит тиража | Например 300 шт |
| Статус | `"draft"` / `"published"` / `"closed"` |

### 8.2. Наполнение дропа

- Привязка дизайнов к дропу (drop_items)
- Порядок (position)
- Автонумерация edition: "043/300"
- Отдельная витрина дропа на клиенте

### 8.3. Правила продаж

- "Доступно" / "Распродано" (по edition_assignments)
- Нумерация привязывается к order_item при покупке

## 9. Управление лимитами / тарифами

### 9.1. Настраиваемые параметры (app_settings)

| Ключ | Описание | Пример |
|------|----------|--------|
| `guest_daily_limit` | Генерации гостя в сутки | 3 |
| `user_daily_limit` | Генерации пользователя в сутки | 30 |
| `unlimited_price_cents` | Цена безлимита | 10000 (100 ₽) |
| `unlimited_duration_hours` | Длительность безлимита | 24 |
| `rate_limit_per_minute` | Макс генераций в минуту | 5 |
| `max_parallel_jobs` | Макс параллельных задач | 2 |
| `base_price_cents` | Цена Base | 259900 |
| `pro_price_cents` | Цена Pro | 319900 |
| `elite_price_cents` | Цена Elite | 899900 |

### 9.2. Промокоды (опционально)

- Скидка % или фиксированная
- Лимит использований
- Период действия

## 10. Аудит-лог

### 10.1. Что логируется

Все действия админов/модераторов:
- `tag.create`, `tag.update`, `tag.delete`, `tag.merge`
- `style.create`, `style.publish`, `style.hide`
- `order.status_change`, `order.refund`
- `design.block`, `design.unblock`
- `settings.update`
- `drop.create`, `drop.publish`

### 10.2. Структура записи

| Поле | Описание |
|------|----------|
| actor_user_id | Кто сделал |
| action | Что сделал |
| record_type + record_id | Над чем |
| before | Состояние до (JSON) |
| after | Состояние после (JSON) |
| ip | IP-адрес |
| created_at | Когда |
