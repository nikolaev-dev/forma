# 05. Генерация — FORMA

> Версия: v0.1 | Дата: 2026-02-14

## 1. Ключевые требования

1. Провайдеры генерации подключаются через **единый интерфейс** (сменяемый)
2. Генерация всегда **асинхронная** (Sidekiq)
3. На каждый запуск — ровно **3 превью** (main + mutation A + mutation B)
4. Поддержка **стабильности стиля** (докрутка сохраняет узнаваемость)
5. Встроенная **модерация** промптов/результатов

## 2. Абстракция провайдера (Provider Interface)

### 2.1. Обязательные методы

```ruby
class GenerationProvider
  # Создать генерацию
  def create_generation(request) -> provider_job_id

  # Получить статус
  def get_status(provider_job_id) -> "pending" | "running" | "succeeded" | "failed"

  # Получить результат
  def fetch_result(provider_job_id) -> { images: [...], metadata: {...} }

  # Отменить (опционально)
  def cancel(provider_job_id)
end
```

### 2.2. Параметры запроса

| Параметр | Описание |
|----------|----------|
| prompt | Исходный промпт пользователя |
| tags | Нормализованные теги (public + hidden) |
| style_preset | Пресет стиля (JSON) |
| seed | Для воспроизводимости (опционально) |
| quality | `"preview"` / `"hires"` |
| policy_flags | Запрет логотипов/брендов |

## 3. Сборка промпта (Prompt Composer)

### 3.1. Назначение

Сервис формирует **финальный промпт** из:

1. Текста пользователя
2. Выбранного стиля (тон/эстетика)
3. Тегов (публичных)
4. Скрытых тегов (аккуратно)
5. Системных ограничений (без логотипов, без копирования)

### 3.2. Принцип

- Brand-теги -> mood, а не "нарисуй логотип"
- Системный суффикс: "no logos, no brand names, no copyrighted characters"
- Стиль влияет на "тон" промпта (минимализм -> чистые линии, мало деталей)

### 3.3. Выходной формат

```
{
  composed_prompt: "final text for provider...",
  tags_used: ["gold", "minimalism", "japan"],
  hidden_tags_used: ["warm_palette", "geometric"],
  policy_applied: ["no_logos", "brand_mood_only"]
}
```

## 4. Мутации (Tag Mutation Engine)

### 4.1. Правило

При каждом "Сгенерировать":
- **1 основной** результат (по промпту пользователя)
- **+2 мутации**, в которые подбрасываются 1-2 тега (или замена)

### 4.2. Алгоритм подбора тегов

Теги берутся из:
1. **Предпочтения пользователя** (лайки стилей -> user_tag_affinities)
2. **Контекст промпта** (связанные теги через tag_relations)
3. **Глобальные тренды** (популярные теги, опционально)
4. **Допустимые категории** (без конфликтующих)

### 4.3. Ограничения

- Не повторять теги, которые уже есть
- Не подбрасывать запрещенные (is_banned)
- Избегать бессмысленных сочетаний (tag_relations: conflicts_with)
- Не подбрасывать рискованные brand-теги без флага brand_mood

### 4.4. Генерация объяснения

Каждая мутация формирует `mutation_summary`:
- "Заменили золото -> серебро"
- "Добавили: tiffany mood, минимализм"
- "Усилили: строгость"

### 4.5. UI

На превью мутации показывается:
- Плашка с объяснением
- Кнопка "Принять изменения" (делает мутацию новым основным)

## 5. Пайплайн генерации (MVP)

### 5.1. Шаги

```
1. Пользователь нажимает "Сгенерировать"
   |
2. Создать Generation (status: "created")
   |
3. Сформировать 3 GenerationVariant:
   - Main (kind: "main")
   - MutA (kind: "mutation_a") + выбрать мутационные теги
   - MutB (kind: "mutation_b") + выбрать мутационные теги
   |
4. Для каждого варианта:
   - Prompt Composer -> composed_prompt
   - Отправить провайдеру (параллельно, с лимитами)
   |
5. Generation.status -> "queued" -> "running"
   |
6. Получить результаты от провайдера
   - Сохранить изображения в Object Storage (ActiveStorage)
   - Variant.status -> "succeeded" / "failed"
   |
7. Пост-обработка:
   - Генерация мокапа блокнота (наложение на шаблон)
   - Генерация thumbnail
   |
8. Generation.status -> "succeeded" / "partial" / "failed"
   |
9. Отдать клиенту 3 карточки превью
```

### 5.2. State Machine: Generation

```
"created" -> "queued"    (поставлена в очередь Sidekiq)
"queued"  -> "running"   (провайдер начал обработку)
"running" -> "partial"   (1-2 варианта готовы, остальные еще нет / упали)
"running" -> "succeeded" (все 3 варианта готовы)
"running" -> "failed"    (все 3 варианта упали)
"partial" -> "succeeded" (оставшиеся варианты готовы)
"partial" -> "failed"    (timeout или все оставшиеся упали)
*         -> "canceled"  (пользователь отменил)
```

### 5.3. State Machine: GenerationVariant

```
"created"   -> "queued"     (отправлен провайдеру)
"queued"    -> "running"    (провайдер обрабатывает)
"running"   -> "succeeded"  (результат получен)
"running"   -> "failed"     (ошибка провайдера)
```

## 6. Качество и форматы изображений

### 6.1. Производственные форматы

| Формат | Назначение | Размер |
|--------|-----------|--------|
| thumb | Быстрая загрузка (списки, витрина) | ~200px |
| preview | Для выбора (экран результатов) | ~800px |
| hires | Для печатного макета обложки | ~2400px+ |
| mockup | Мокап на блокноте | ~1200px |

### 6.2. Печать

- Итоговый файл обложки: **print-ready PDF**
- Параметры формата/bleed/поля — конфигурируемые в админке
- Внутренний блок: **print-ready PDF**
- MVP: RGB -> PDF. В будущем: CMYK + профили

## 7. Модерация

### 7.1. Фильтр промптов

- Словарь запрещенных слов/тем
- Проверка перед отправкой провайдеру
- Блок или `moderation_status: "requires_review"`

### 7.2. Фильтр результатов

- Флаг `requires_review` для спорных случаев
- Автодетекция (опционально, фаза 2)

### 7.3. Запрет генерации

- Логотипов
- Точных копий фирменных персонажей/маскотов
- Прямых упаковок/этикеток

### 7.4. Жалобы

- Кнопка "Пожаловаться" на публичной странице дизайна
- Запись в moderation_reports
- Очередь модерации для модератора/админа

## 8. Логи и наблюдаемость

### 8.1. Что логировать

| Данные | Описание |
|--------|----------|
| Финальный промпт | С маскированием чувствительных частей |
| Теги/мутации | Какие подбросили |
| Провайдер, модель | Кто генерировал |
| Время | started_at, finished_at, latency |
| Стоимость/квота | Если учитываете |
| Ошибки | error_code, error_message |

### 8.2. Метрики

| Метрика | Описание |
|---------|----------|
| time-to-preview | От запуска до готового превью |
| conversion: generation -> select -> order | Воронка |
| share rate | Доля дизайнов, которыми поделились |
| repeat generation rate | Повторные генерации (докрутки) |
| mutation acceptance rate | Как часто выбирают мутацию вместо основного |
