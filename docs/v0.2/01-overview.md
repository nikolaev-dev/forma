# 01. Общее описание — FORMA

> Версия: v0.2 | Дата: 2026-02-15

## 1. Название и суть

**FORMA** — сервис, где пользователь выбирает дизайн обложки блокнота из каталога курированных коллекций или генерирует свой через промпт/теги, выбирает уровень исполнения (Core / Signature / Lux), наполнение, и заказывает блокнот с оплатой через ЮKassa.

Два пути к продукту:
1. **Каталог** — дизайны, подготовленные куратором через Training Pipeline (3 уровня исполнения)
2. **Генерация** — пользователь сам задает промпт/теги, получает 3 превью (основное + 2 мутации)

## 2. Цель продукта

Пользователь:
1. Просматривает каталог коллекций/стилей **или** генерирует свой дизайн
2. Выбирает уровень исполнения (Core / Signature / Lux)
3. Выбирает наполнение (клетка/линейка/точки/пустые)
4. Оформляет и оплачивает заказ через ЮKassa
5. Получает блокнот с FORMA DNA — узнаваемыми физическими элементами бренда

## 3. Технологический стек

| Компонент | Технология |
|-----------|-----------|
| Backend | Ruby on Rails 8+ |
| DB | PostgreSQL 16+ (citext, pg_trgm, unaccent) |
| Очереди/джобы | Sidekiq + Redis |
| Хранилище файлов | ActiveStorage + S3-compatible (Yandex Object Storage / MinIO) |
| Оплата | ЮKassa (webhooks, идемпотентные) |
| Аутентификация | OmniAuth (VK, Яндекс, T-Bank, Альфа, Gmail) |
| Генерация изображений | Абстракция провайдеров (сменяемый интерфейс) |
| AI-анализ (Training Pipeline) | Claude Vision + GPT-4V (A/B) |
| Frontend | Hotwire (Turbo + Stimulus), Tailwind CSS |
| Asset pipeline | Propshaft + importmap |

## 4. Формат интерфейса

- **Mobile-first** (основной сценарий — телефон)
- Desktop — адаптивный (не отдельное приложение)

## 5. Термины и сущности

| Термин | Определение |
|--------|------------|
| Промпт | Текстовое описание обложки/стиля |
| Тег | Элемент управляемого словаря (страна, сезон, стихия, материал, настроение...) |
| Скрытые теги | Теги для системы (поиск/мутации/аналитика), не показываются пользователю |
| Стиль | Карточка стиля в каталоге (пример + набор тегов + пресет генерации) |
| Генерация | Запуск пайплайна создания дизайна (превью/варианты) |
| Превью | Быстрый результат (картинка + мокап) |
| Вариант | Одно из предложений по дизайну (включая "мутации") |
| Мутация | Автоматическая модификация дизайна подбросом 1-2 тегов |
| Ремикс | Создание нового дизайна на базе чужого (fork) с сохранением происхождения |
| Наполнение | Тип внутреннего блока (клетка/линейка/точки/планер/пустые) |
| **Tier (уровень)** | Core / Signature / Lux — уровень исполнения блокнота (технология + материалы) |
| **Коллекция** | Группировка дизайнов по теме/настроению (regular или limited) |
| **Дроп** | Лимитированный выпуск с нумерацией экземпляров (N/300) |
| **Референс** | Фото реального блокнота для training pipeline (AI-анализ → промпт → генерация) |
| **Training Pipeline** | Процесс: загрузка фото → AI-анализ → курирование → 3-tier генерация → публикация |
| Кредиты генераций | Лимиты/баланс/покупка доступа |
| Design DNA Card | Карточка происхождения дизайна (в блокноте) |

## 6. Роли и права доступа

### 6.1. Роли

| Роль | Описание |
|------|----------|
| Гость | Просмотр каталога, ограниченные генерации, шаринг превью |
| Пользователь | Генерации, докрутка, ремиксы, сохранения, заказ/оплата, история |
| Создатель (фаза 3) | Публикация промптов/стилей в каталог (через модерацию) |
| Модератор | Очереди модерации, блокировки |
| Админ | Теги, стили, каталог, коллекции, дропы, генерации, заказы, оплаты, лимиты, training pipeline |

### 6.2. Enum ролей (string)

```ruby
# user.role
"user"       # обычный пользователь
"creator"    # создатель (фаза 3)
"moderator"  # модератор
"admin"      # администратор
```

## 7. Бренд FORMA

### 7.1. Ключевая идея

FORMA — не "печать кастома", а **редакция вкуса + ритуал + коллекционирование**:

- **Редакция:** каталог стилей и коллекций, курирование через Training Pipeline, tier-система
- **Ритуал:** удобство ежедневного использования (наполнения, качество бумаги, фурнитура)
- **Коллекция:** Edition numbering, Drops, DNA Card, QR-история, ремиксы

### 7.2. FORMA DNA — физические элементы бренда

В каждом блокноте FORMA присутствуют **4 обязательных элемента**, масштабируемых по уровню:

#### 1. Шестигранный шильд (hex badge)

Минимальный брендинг: грань / кристалл / инженерность. Без кричащего логотипа.

| Core | Signature | Lux |
|------|-----------|-----|
| Мелкий принт (или отсутствует) | Слепое тиснение | Полированный металл, ювелирный |

#### 2. Две закладки (dual bookmarks)

Всегда две. Фиксированная пара цветов для бренда.

| Core | Signature | Lux |
|------|-----------|-----|
| Тканевые, без наконечников | Тканевые, без наконечников | С металлическими hex-наконечниками |

#### 3. Срезанный угол 45° (chamfered corner)

Верхний правый угол. Увидел — узнал. Одинаковый на всех уровнях.

#### 4. Карточка/паспорт FORMA DNA

Внутренний кармашек с карточкой: коллекция, номер, дата, QR на страницу дизайна.

| Core | Signature | Lux / Limited |
|------|-----------|---------------|
| Простая карточка | + персонализация (инициалы) | Номерной паспорт коллекционера |

#### Волна (опциональный элемент)

S-curve волна на обложке — **рекомендуемый стилевой элемент, но не обязательный**. Может использоваться как часть дизайна:

| Core | Signature | Lux |
|------|-----------|-----|
| Плоский принт | Spot UV лак (бликует) | Embossing + doming-линза (объём + глубина) |

### 7.3. Уровни исполнения (Tiers)

> Разница — **производственная** (технология + материалы), не только эстетическая.

| Уровень | Ценовой диапазон | Суть | Обложка | Технология |
|---------|-----------------|------|---------|------------|
| **Core** | TBD | "Красивая картинка, хороший массовый продукт" | Бумажная (coated paper wrap), ламинация | Плоская печать, без лака, без тиснения, без металла |
| **Signature** | TBD | "Берёшь в руки и чувствуешь разницу" | Бумажная + soft-touch ламинация | Spot UV по волне, слепое тиснение, мягкая ламинация |
| **Lux** | TBD | "Другая физика изделия" | Натуральная кожа с зерном | Deep embossing, doming-линза, металл, магнитный замок, окрашенный торец |

**Limited Edition** — тираж N штук, по цене Lux, но с:
- Уникальным рисунком вставки на каждом экземпляре
- Нумерацией (1/30...30/30) на шильде
- Особым форзацем и цветами лент
- Паспортом коллекционера + подпись

**Ключевой принцип:**
- Core → Signature: разница в **тактильности** (лак, soft-touch, тиснение)
- Signature → Lux: разница в **конструкции + материалах** (кожа, металл, магнит, edge paint)

### 7.4. Тон бренда

- Редакционный, не технологичный
- Спокойный, умный
- Короткие формулировки
- Ощущение вкуса и статуса без пафоса
- "Редакция вкуса", не "AI-генератор"

## 8. Нефункциональные требования

### 8.1. Производительность
- Каталог и поиск: < 500 мс
- Превью: прогрессивная загрузка (thumb -> medium)
- Генерации: асинхронные (очередь Sidekiq)
- AI-анализ (Training Pipeline): фоновый, не блокирует UI

### 8.2. Надежность
- Повторяемость джоб при сбое (retry)
- Идемпотентные webhooks оплаты
- Логи по генерациям и оплатам
- Идемпотентность AI-анализа (повторный анализ не затирает курированные данные)

### 8.3. Безопасность
- OAuth через проверенные стратегии
- Rate limit на генерации
- Хранение персональных данных с учетом требований РФ

### 8.4. Масштаб
- Training Pipeline: 400 фото сейчас, пачки по 50-100 дальше
- AI-анализ: ~$0.01-0.03/фото = $4-12 за 400

## 9. Критерии приемки (v0.2)

v0.2 принята, если:
- [ ] Есть 3 уровня исполнения (Core / Signature / Lux) с визуальной и производственной разницей
- [ ] Есть tier_modifiers с промпт-шаблонами для каждого уровня
- [ ] Есть коллекции (regular + limited) с публичными страницами
- [ ] Есть дропы с нумерацией экземпляров
- [ ] Есть Training Pipeline: загрузка → AI-анализ → курирование → 3-tier генерация → публикация
- [ ] Есть brand identity (4 обязательных элемента) в промптах и DNA Card
- [ ] Пользователь может выбрать уровень при заказе (S9 обновлён)
- [ ] Каталог наполнен 50+ дизайнами через Training Pipeline
- [ ] Все оставшиеся экраны из MVP реализованы (поиск, профиль, онбординг, докрутка)
