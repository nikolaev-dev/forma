# 03. Публичная часть — FORMA

> Версия: v0.2 | Дата: 2026-02-15

---

## 1. Каталог стилей (входной)

### 1.1. Назначение

Максимально быстро "вытянуть" вкус пользователя и направить его в создание блокнота. Два пути: выбрать готовый дизайн из каталога (куратор) или сгенерировать свой.

### 1.2. Карточка стиля

| Поле | Описание |
|------|----------|
| Изображение-пример | Мокап обложки на блокноте |
| Название | Короткое, "редакционное" |
| Описание | 1 строка |
| Теги | 3-6 штук (часть может быть скрыта) |
| Пресет генерации | Параметры модели/шаблона (не показывается) |
| Популярность/рейтинг | Если есть |
| Tier badge | Для каталожных дизайнов: Core / Signature / Lux (см. раздел 8) |
| Collection badge | Если дизайн входит в коллекцию (см. раздел 9) |

### 1.3. Механика "Выбери, что нравится"

- Минимум 12 карточек на старт
- После 5 лайков -- предложение "создать"
- Профиль предпочтений сохраняется (user_preferences / style_votes)
- На телефоне: свайп или сетка + быстрый лайк

### 1.4. Витрины каталога

| Витрина | section_type | Описание | Правила |
|---------|-------------|----------|---------|
| Редакция FORMA | `editorial` | Отобранные админом | admin_rating >= 4 |
| Популярное сегодня | `popular` | По метрикам | просмотры + заказы + оценки |
| Новые | `new` | Хронологические | последние N дней |
| Дроп | `drop` | Лимитированные выпуски | привязка к Drop, показ "N/300" |
| Коллекция | `collection` | Горизонтальная секция коллекций | привязка к Collection, показ обложки + название |
| Категории | `custom` | По стилям | минимализм, люкс, винтаж, техно... |

**Секция "Коллекция" на S1 (каталог):**
- Горизонтальный scroll с карточками коллекций
- Каждая карточка: обложка коллекции + название + количество дизайнов
- Для лимитированных коллекций: badge "Осталось X/N"
- По тапу -- переход на страницу коллекции (`/collections/:slug`)

**Секция "Дроп" на S1 (каталог):**
- Горизонтальный scroll или hero-баннер для активного дропа
- Показывает: название, количество оставшихся экземпляров, дата окончания (если есть)
- По тапу -- переход на страницу дропа (`/drops/:slug`)

---

## 2. Поиск

### 2.1. Виды поиска

| Тип | Описание | Реализация |
|-----|----------|-----------|
| По словам (full-text) | Текстовый поиск | PostgreSQL tsvector + trigram |
| По тегам (faceted) | Фильтрация чипсами | JOIN по design_tags |
| По коллекции | Фильтрация по коллекции | JOIN по collection_id |
| По похожести промптов | Семантический (фаза 3) | Векторный поиск |

### 2.2. Автодополнение

- Trigram-индекс на `tags.name`
- Подсказки тегов при вводе
- Быстрый отклик (< 200 мс)

### 2.3. Фильтры

- Стиль
- Категории тегов
- Коллекция (включая "Лимитированная серия" как фильтр)
- Тариф / Tier (если применимо)
- Популярное / Новое

### 2.4. Сортировки

- Популярность
- Рейтинг
- Новизна
- "Похоже на мой вкус" (по профилю предпочтений)

---

## 3. Популярное

### 3.1. Контент

- Топ дизайнов
- Топ промптов
- Топ ремиксов

### 3.2. Метрики для ранжирования

| Метрика | Вес (настраиваемо) |
|---------|-------------------|
| Просмотры | Базовый |
| Выбор/покупки | Высокий |
| Оценки (1-5) | Средний |
| Сохранения (избранное) | Средний |
| Шаринг | Высокий |

### 3.3. popularity_score

Вычисляемое поле на `designs.popularity_score`:
- Обновляется периодически (Sidekiq job)
- Формула настраивается через `app_settings`

---

## 4. Ремиксы

### 4.1. Механика

- Любой **публичный** дизайн/промпт можно "взять и докрутить"
- Создается fork (новый `design` с `source_design_id`)
- Сохраняется родословная

### 4.2. На странице дизайна

- Блок "Ремиксы" -- горизонтальная лента форков
- "Создан из: [ссылка на исходник]"

### 4.3. Данные

```
designs.source_design_id -> родительский дизайн
prompt_versions.change_reason = "remix"
prompt_versions.diff_summary = "forked from ..."
```

---

## 5. Шаринг

### 5.1. Требования (обязательно для роста бренда)

- **Share-картинка:** превью + название дизайна + маленький знак FORMA
- **Короткий URL:** на публичную страницу дизайна
- **Share в 1 тап:** iOS/Android системный шаринг
- **Watermark:** минимальный, не портит превью

### 5.2. Публичная страница дизайна (S7)

URL: `/d/:slug` или `/designs/:hashid` (6 символов)

Содержимое:
- Большое превью + галерея
- Название, теги (только публичные)
- **Tier-превью** -- для каталожных дизайнов: 3 уровня (Core / Signature / Lux); для пользовательских: одно превью (см. раздел 8)
- Кнопки: "Ремикснуть", "Сделать похожий", "Заказать"
- FORMA DNA: "Собрано из: ...", дата, ID
- Блок "Ремиксы", "Похожие по вкусу"
- **Принадлежность к коллекции** (если есть): название коллекции + ссылка на страницу коллекции
- **Edition badge** (если дроп): "043/300"

### 5.3. OG/meta-теги

Для красивого превью в мессенджерах/соцсетях:
- `og:title` -- название дизайна
- `og:image` -- share-картинка
- `og:description` -- теги + "Создай свой на FORMA"
- Для дизайнов в коллекции: `og:description` включает название коллекции

---

## 6. Система тегов (публичная часть)

### 6.1. Типы тегов

| Тип | Показывается пользователю |
|-----|--------------------------|
| public | Да -- как чипсы/фильтры |
| hidden | Нет -- только для системы |

### 6.2. Категории тегов

| # | Категория | Примеры |
|---|-----------|---------|
| 1 | География | Все страны мира (+ города опционально) |
| 2 | Времена года | Весна, лето, осень, зима |
| 3 | Стихии | Огонь, вода, земля, воздух |
| 4 | Бренды одежды* | "Brand mood" -- вдохновение, без логотипов |
| 5 | IT/соцсети* | "Brand mood" |
| 6 | Бренды lifestyle* | ikea mood, starbucks mood |
| 7 | Стили мебели | Модерн, ар-деко, скандинавский... |
| 8 | Архитектура | Барокко, минимализм, хай-тек... |
| 9 | Палитры/материалы | Золото, серебро, хром, пастель, неон... |
| 10 | Типографика/настроение | Строго, люкс, минимализм, барокко, киберпанк |
| 11 | Техники/текстуры | Акварель, масло, гравюра, коллаж... |
| 12 | Паттерны | Геометрия, полоска, клетка, абстракция... |
| 13 | Эпохи/культуры | Ренессанс, 70-е, японский, скандинавский... |

*Brand mood -- вдохновение, без логотипов и копирования.

### 6.3. Скрытые теги в выдаче

- По умолчанию не показываются
- Можно показывать "объяснение" мутаций: "Мы добавили: ..."
- Показывать только безопасные/публичные аналоги

---

## 7. Наполнения (выбор пользователем)

### 7.1. Список наполнений

| Тип | Slug | Описание |
|-----|------|----------|
| Клетка | `grid` | Стандартная клетка |
| Линейка | `ruled` | Линованные страницы |
| Точки | `dot` | Dot grid |
| Пустые | `blank` | Чистые страницы |
| Планер недельный | `planner_weekly` | Недатированный |
| Ежедневник | `planner_daily` | Недатированный |
| Датированный | `dated` | Датированный ежедневник |

### 7.2. Параметры при выборе

- Формат (A5 / B5 -- задается бизнесом)
- Нумерация страниц (да/нет)
- Язык/локаль (ru по умолчанию)
- Поля (узкие/стандарт) -- опционально

### 7.3. Генерация PDF

Каждое наполнение генерирует print-ready PDF внутреннего блока.

---

## 8. Tier-система на публичных страницах

### 8.1. Два контекста отображения

Дизайны в FORMA бывают двух типов по происхождению, и tier-система отображается по-разному:

| Тип дизайна | Источник | Tier-отображение |
|-------------|----------|------------------|
| **Каталожный** (curator-generated) | Training Pipeline, admin_batch | 3 превью: Core / Signature / Lux |
| **Пользовательский** (user-generated) | Генерация пользователем | 1 превью, без tier axis |

### 8.2. Каталожные дизайны: 3-tier превью

На странице каталожного дизайна (S7) показываются 3 уровня исполнения:

```
┌─────────────────────────────────────────┐
│         "Осенний минимализм"            │
│                                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │  Core   │ │Signature│ │   Lux   │   │
│  │         │ │         │ │         │   │
│  │ (мокап) │ │ (мокап) │ │ (мокап) │   │
│  │         │ │         │ │         │   │
│  └─────────┘ └─────────┘ └─────────┘   │
│                                         │
│  Каждый мокап показывает реальную       │
│  разницу: материалы, текстура, финиш    │
│                                         │
│  [Выбрать Core]  [Signature]  [Lux]     │
└─────────────────────────────────────────┘
```

- **Core:** плоская печать, бумажная обложка -- чистая картинка
- **Signature:** soft-touch ламинация, spot UV, слепое тиснение -- тактильность
- **Lux:** кожа, embossing, doming-линза, металл -- другая физика

Пользователь видит **визуальную и тактильную разницу** на мокапе, а не просто ценник.

### 8.3. Пользовательские дизайны: без tier axis

Для дизайнов, созданных пользователем через генерацию:
- Показывается одно превью (основное изображение)
- Tier выбирается на этапе заказа (S9), но не является частью промпт-вариаций
- Tier влияет только на производственные параметры, а не на изображение

### 8.4. Tier badge на карточках каталога

В каталоге (S1) карточки каталожных дизайнов содержат tier badge:

| Badge | Визуал | Описание |
|-------|--------|----------|
| `Core` | Нейтральный, мелкий | Базовый уровень |
| `Signature` | Акцентный, средний | Рекомендуемый |
| `Lux` | Золотой/премиальный | Коллекционный |

Badge показывает **текущий выбранный tier** при наведении/тапе, или tier с лучшей карточкой по умолчанию (обычно Signature).

---

## 9. Коллекции

### 9.1. Назначение

Коллекция -- группировка дизайнов по теме, настроению или серии. Примеры: "Осенний минимализм", "Город и камень", "Tokyo Nights".

Коллекции -- инструмент **редакционной курации**: админ объединяет дизайны в смысловые группы, создавая ощущение серийности и editorial-подхода.

### 9.2. Типы коллекций

| Тип | `collection_type` | Описание | Поведение |
|-----|-------------------|----------|-----------|
| **Regular** | `regular` | Обычная тематическая коллекция | Без ограничений по количеству, новые дизайны можно добавлять |
| **Limited** | `limited` | Лимитированная серия | `edition_size` задан, `stock_remaining` уменьшается при продаже |

### 9.3. Сущность Collection

| Поле | Описание |
|------|----------|
| name | Название коллекции ("Осенний минимализм") |
| slug | URL-friendly идентификатор |
| description | Описание (1-3 абзаца, markdown) |
| collection_type | `"regular"` / `"limited"` |
| edition_size | Только для limited: общий тираж (например, 100) |
| stock_remaining | Только для limited: сколько осталось |
| status | `"draft"` / `"published"` / `"archived"` |
| cover_image | Обложка коллекции (ActiveStorage) |
| position | Порядок в каталоге |

Связь с дизайнами: `designs.collection_id` (опциональный FK). Дизайн может принадлежать максимум одной коллекции (или не принадлежать ни одной).

### 9.4. Публичная страница коллекции

**URL:** `/collections/:slug`

**Содержимое:**

```
┌─────────────────────────────────────────┐
│                                         │
│  [Обложка коллекции -- hero image]      │
│                                         │
│  "Осенний минимализм"                   │
│  Коллекция из 12 дизайнов               │
│                                         │
│  Описание: "Тёплые оттенки,            │
│  чистые линии, осеннее настроение..."   │
│                                         │
│  ┌───┐ ┌───┐ ┌───┐ ┌───┐              │
│  │ 1 │ │ 2 │ │ 3 │ │ 4 │              │
│  └───┘ └───┘ └───┘ └───┘              │
│  ┌───┐ ┌───┐ ┌───┐ ┌───┐              │
│  │ 5 │ │ 6 │ │ 7 │ │ 8 │              │
│  └───┘ └───┘ └───┘ └───┘              │
│  ...                                    │
│                                         │
│  (Для limited: badge внизу)             │
│  "Осталось 7 из 30"                     │
│                                         │
└─────────────────────────────────────────┘
```

**Элементы страницы:**

| Элемент | Описание |
|---------|----------|
| Hero image | Обложка коллекции (cover_image), полная ширина |
| Название | Крупный заголовок |
| Мета | Количество дизайнов, дата создания |
| Описание | 1-3 абзаца, редакционный текст |
| Сетка дизайнов | Карточки дизайнов коллекции (мокапы + tier badge) |
| Stock badge (limited) | "Осталось X из N" -- только для limited коллекций |
| Share | Кнопка шаринга коллекции |

### 9.5. Лимитированные коллекции

Для коллекций с `collection_type = "limited"`:

- **Badge на карточке в каталоге:** "Лимитированная серия" + "Осталось X/N"
- **Badge на странице коллекции:** "Осталось X из N" (обновляется в реальном времени)
- **Когда stock_remaining = 0:** badge меняется на "Распродано", кнопка заказа недоступна
- **stock_remaining** уменьшается при подтверждении оплаты (status = "paid")

Поведение при покупке:
1. Пользователь выбирает дизайн из limited коллекции
2. При оформлении заказа проверяется `stock_remaining > 0`
3. stock_remaining декрементируется атомарно при переходе платежа в `succeeded`
4. Если stock_remaining стал 0 между началом оформления и оплатой -- заказ отменяется, средства возвращаются

### 9.6. Коллекция на карточке дизайна

Если дизайн принадлежит коллекции, на его карточке (в каталоге и на странице дизайна) отображается:
- Маленький badge с названием коллекции (ссылка на страницу коллекции)
- Для limited: дополнительный badge "Лимитированная серия"

### 9.7. Коллекции в фильтрах

- В поиске: фильтр "Коллекция" -- dropdown или чипсы с названиями коллекций
- Отдельный фильтр "Только лимитированные" (boolean)
- Результат фильтрации: дизайны, принадлежащие выбранной коллекции

---

## 10. Дропы

### 10.1. Назначение

Дроп -- лимитированный выпуск с нумерацией экземпляров. Каждый проданный блокнот получает уникальный номер в рамках тиража (например, "043/300").

Дропы -- инструмент **коллекционности и FOMO**: ограниченный тираж, уникальная нумерация, дата начала/окончания.

> **Дропы и коллекции -- отдельные сущности.** Дроп может быть привязан к коллекции (через `collection_id`), но это не обязательно. Коллекция -- про тематическую группировку; дроп -- про лимитированный тираж с нумерацией.

### 10.2. Сущность Drop

| Поле | Описание |
|------|----------|
| name | Название дропа ("Tokyo Nights Drop") |
| slug | URL-friendly идентификатор |
| description | Описание (markdown) |
| status | `"draft"` / `"published"` / `"closed"` |
| starts_at | Дата начала продаж (может быть NULL -- сразу активен) |
| ends_at | Дата окончания (может быть NULL -- пока не распродан) |
| edition_limit | Общий тираж (например, 300) |
| collection_id | FK на Collection (опциональный) |

Связь с дизайнами: `drop_items` (M2M) -- дроп содержит N дизайнов.

### 10.3. Нумерация экземпляров

Каждый проданный блокнот из дропа получает edition number через таблицу `edition_assignments`:

```
edition_assignments:
  drop_id: 5
  design_id: 42
  order_item_id: 789
  edition_number: 43
  edition_total: 300
  status: "assigned"
```

**Отображение:** "043/300" -- на DNA Card, на странице дизайна, в заказе.

### 10.4. Публичная страница дропа

**URL:** `/drops/:slug`

**Содержимое:**

```
┌─────────────────────────────────────────┐
│                                         │
│  "Tokyo Nights Drop"                    │
│  Лимитированная серия — 300 экземпляров │
│                                         │
│  Описание: "Неоновый Токио,            │
│  вечерний город, электрический          │
│  минимализм..."                         │
│                                         │
│  ┌───────────────────────────┐          │
│  │    Прогресс-бар тиража    │          │
│  │  ████████████░░░░  234/300│          │
│  │    "Осталось 66"          │          │
│  └───────────────────────────┘          │
│                                         │
│  Дата окончания: 28 февраля 2026        │
│                                         │
│  ┌───┐ ┌───┐ ┌───┐ ┌───┐              │
│  │ 1 │ │ 2 │ │ 3 │ │ 4 │              │
│  └───┘ └───┘ └───┘ └───┘              │
│  (Дизайны дропа)                        │
│                                         │
│  Часть коллекции: "Tokyo Nights" →      │
│  (ссылка, если привязан к коллекции)    │
│                                         │
└─────────────────────────────────────────┘
```

**Элементы страницы:**

| Элемент | Описание |
|---------|----------|
| Название | Крупный заголовок дропа |
| Edition info | "Лимитированная серия -- N экземпляров" |
| Описание | Редакционный текст |
| Прогресс-бар тиража | Визуальный прогресс продаж (sold / total) |
| Оставшиеся | "Осталось X" (обновляется в реальном времени) |
| Дата окончания | Если `ends_at` задан |
| Сетка дизайнов | Карточки дизайнов дропа (через `drop_items`) |
| Связь с коллекцией | Ссылка на коллекцию (если `collection_id` задан) |
| Share | Кнопка шаринга |

### 10.5. Дроп на карточке дизайна

Если дизайн входит в активный дроп, на его карточке отображается:
- Badge "Drop" с названием
- Edition numbering: "043/300" (если экземпляр уже присвоен)
- Ссылка на страницу дропа

### 10.6. Состояния дропа

| Статус | Описание | Поведение |
|--------|----------|-----------|
| `draft` | Черновик, не виден публично | Не отображается в каталоге |
| `published` | Активный, можно покупать | Показывается в каталоге, доступен для заказа |
| `closed` | Завершён (распродан или дата вышла) | Показывается как "Завершён", заказ недоступен |

Автоматическое закрытие:
- Когда все edition_assignments со статусом `assigned` (тираж распродан)
- Когда `ends_at` < текущее время (через Sidekiq cron job)

---

## 11. Витрины каталога: полная спецификация

### 11.1. section_type enum

```ruby
enum :section_type, {
  editorial:  "editorial",
  popular:    "popular",
  new:        "new",
  drop:       "drop",
  collection: "collection",
  custom:     "custom"
}
```

### 11.2. Логика формирования

| section_type | Источник данных | Сортировка |
|-------------|----------------|------------|
| `editorial` | catalog_items (admin pinned) | position |
| `popular` | designs WHERE popularity_score > threshold | popularity_score DESC |
| `new` | designs WHERE created_at > N.days.ago | created_at DESC |
| `drop` | drop_items JOIN drops WHERE status = "published" | drops.position, drop_items.position |
| `collection` | collections WHERE status = "published" | collections.position |
| `custom` | catalog_items (admin curated) | position |

### 11.3. Секция "collection" -- детали

Секция типа `collection` на главной странице каталога (S1):

- **Формат:** горизонтальный scroll карточек коллекций
- **Каждая карточка:** cover_image + name + кол-во дизайнов + badge (limited/regular)
- **По тапу:** переход на `/collections/:slug`
- **Сортировка:** по полю `position` на Collection
- **Фильтрация:** только `status = "published"`

### 11.4. Секция "drop" -- детали

Секция типа `drop` на главной странице каталога (S1):

- **Формат:** hero-баннер для главного дропа или горизонтальный scroll для нескольких
- **Содержимое:** название дропа, кол-во оставшихся, дата окончания, 2-3 превью дизайнов
- **По тапу:** переход на `/drops/:slug`
- **Фильтрация:** только `status = "published"`

---

## 12. OG/meta-теги для новых сущностей

### 12.1. Коллекция

```html
<meta property="og:title" content="Осенний минимализм — FORMA" />
<meta property="og:image" content="{collection.cover_image_url}" />
<meta property="og:description" content="Коллекция из 12 дизайнов. Тёплые оттенки, чистые линии..." />
<meta property="og:url" content="https://forma.ru/collections/autumn-minimalism" />
```

### 12.2. Дроп

```html
<meta property="og:title" content="Tokyo Nights Drop — FORMA" />
<meta property="og:image" content="{drop.hero_image_url}" />
<meta property="og:description" content="Лимитированная серия — 300 экземпляров. Осталось 66." />
<meta property="og:url" content="https://forma.ru/drops/tokyo-nights" />
```

---

## 13. URL-структура (полная)

| Сущность | URL | Fallback |
|----------|-----|----------|
| Каталог | `/` или `/catalog` | -- |
| Стиль | `/styles/:slug` | -- |
| Дизайн | `/d/:slug` | `/designs/:hashid` |
| Коллекция | `/collections/:slug` | -- |
| Дроп | `/drops/:slug` | -- |
| Поиск | `/search?q=...` | -- |
| Профиль | `/profile` | -- |

Приоритет маршрутизации: slug (если есть) > hashid.
